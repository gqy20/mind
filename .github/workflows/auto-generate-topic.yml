name: Auto Generate Chat Topic

on:
  # 北京时间晚上11点到早上6点，每小时生成两个话题
  # 北京时间 = UTC+8，晚上11点 = UTC 15:00，早上6点 = UTC 22:00
  schedule:
    - cron: '0 15-22 * * *'
  # 支持手动触发
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  actions: write

jobs:
  generate_topic:
    name: Generate Chat Topic and Create Issue
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          python-version: "3.13"

      - name: Install dependencies
        run: |
          uv venv .venv
          uv sync --group dev

      - name: Generate topics using Anthropic
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        run: |
          # 生成两个不同的话题
          uv run python .github/scripts/generate_topic.py
          mv /tmp/generated_topic.txt /tmp/topic1.txt
          uv run python .github/scripts/generate_topic.py
          mv /tmp/generated_topic.txt /tmp/topic2.txt

      - name: Read generated topics
        id: read_topics
        run: |
          TOPIC1=$(cat /tmp/topic1.txt)
          TOPIC2=$(cat /tmp/topic2.txt)
          echo "topic1=$TOPIC1" >> $GITHUB_OUTPUT
          echo "topic2=$TOPIC2" >> $GITHUB_OUTPUT

      - name: Create issues with generated topics
        id: create_issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TOPIC1: ${{ steps.read_topics.outputs.topic1 }}
          TOPIC2: ${{ steps.read_topics.outputs.topic2 }}
        run: |
          # 创建第一个 issue 并记录编号
          gh issue create --title "[对话] $TOPIC1" --body "$TOPIC1" --label "chat"
          sleep 2
          ISSUE1=$(gh issue list --limit 1 --search "$TOPIC1" --json number --jq '.[0].number')
          echo "issue1=$ISSUE1" >> $GITHUB_OUTPUT
          sleep 2

          # 创建第二个 issue 并记录编号
          gh issue create --title "[对话] $TOPIC2" --body "$TOPIC2" --label "chat"
          sleep 2
          ISSUE2=$(gh issue list --limit 1 --search "$TOPIC2" --json number --jq '.[0].number')
          echo "issue2=$ISSUE2" >> $GITHUB_OUTPUT

      - name: Trigger conversation for issue 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run issue-chat.yml -f issue_number=${{ steps.create_issues.outputs.issue1 }}
          sleep 5

      - name: Trigger conversation for issue 2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run issue-chat.yml -f issue_number=${{ steps.create_issues.outputs.issue2 }}
