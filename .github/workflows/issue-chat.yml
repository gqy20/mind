name: Issue Chat

on:
  issues:
    types: [opened]
  # ä¹Ÿå¯ä»¥é€šè¿‡æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      issue_number:
        description: Issue ç¼–å·
        required: true
        type: number

permissions:
  contents: write
  issues: write

jobs:
  chat:
    name: Run Conversation via Issue
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          python-version: "3.13"

      - name: Install dependencies
        run: |
          uv venv .venv
          uv sync --group dev

      - name: Get issue details
        id: get_issue
        run: |
          # ç¡®å®šä½¿ç”¨å“ªä¸ª issue ç¼–å·
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER=${{ github.event.inputs.issue_number }}
          else
            ISSUE_NUMBER=${{ github.event.issue.number }}
          fi
          echo "number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          # è·å– issue è¯¦æƒ…
          TITLE=$(gh issue view "$ISSUE_NUMBER" --json title --jq '.title')
          BODY=$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body')
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          # ä½¿ç”¨ heredoc å®‰å…¨åœ°å¤„ç†å¤šè¡Œå†…å®¹å’Œç‰¹æ®Šå­—ç¬¦
          echo "body<<BODYEOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "BODYEOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if chat issue
        id: check_chat
        env:
          ISSUE_TITLE: ${{ steps.get_issue.outputs.title }}
          ISSUE_NUMBER: ${{ steps.get_issue.outputs.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ£€æŸ¥æ˜¯å¦ä¸ºå¯¹è¯ issue
          if echo "$ISSUE_TITLE" | grep -q '^\[å¯¹è¯\]'; then
            echo "is_chat=true" >> $GITHUB_OUTPUT
          elif gh issue view "$ISSUE_NUMBER" --json labels --jq '.labels[].name' | grep -qE '(chat|å¯¹è¯)'; then
            echo "is_chat=true" >> $GITHUB_OUTPUT
          else
            echo "is_chat=false" >> $GITHUB_OUTPUT
            echo "This is not a chat issue, skipping..."
          fi

      - name: Run conversation
        if: steps.check_chat.outputs.is_chat == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ISSUE_TITLE: ${{ steps.get_issue.outputs.title }}
          ISSUE_BODY: ${{ steps.get_issue.outputs.body }}
        run: |
          # æ„å»ºä¸»é¢˜ï¼ˆå¦‚æœ body å­˜åœ¨åˆ™æ¢è¡Œæ‹¼æ¥ï¼‰
          if [ -n "$ISSUE_BODY" ]; then
            TOPIC="$ISSUE_TITLE"$'\n\n'"$ISSUE_BODY"
          else
            TOPIC="$ISSUE_TITLE"
          fi

          # è¿è¡Œå¯¹è¯ï¼ˆå®Œæ•´å¯¹è¯å·²è‡ªåŠ¨ä¿å­˜åˆ° history/*.jsonï¼‰
          uv run python -m mind.cli "$TOPIC" --non-interactive --max-turns 20

      - name: Generate summary comment
        if: steps.check_chat.outputs.is_chat == 'true'
        env:
          ISSUE_NUMBER: ${{ steps.get_issue.outputs.number }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          from pathlib import Path

          # æŸ¥æ‰¾æœ€æ–°çš„å¯¹è¯ JSON æ–‡ä»¶ï¼ˆæ’é™¤æœç´¢å†å²æ–‡ä»¶ï¼‰
          history_dir = Path("history")
          json_files = [
              f for f in history_dir.glob("*.json")
              if not f.name.startswith("search_history")
          ]
          json_files = sorted(json_files, reverse=True)

          if not json_files:
              print("âŒ æœªæ‰¾åˆ°å¯¹è¯æ—¥å¿—æ–‡ä»¶")
              exit(1)

          with open(json_files[0], "r", encoding="utf-8") as f:
              data = json.load(f)

          # æå–å…³é”®ä¿¡æ¯
          topic = data.get("topic", "")
          turn_count = data.get("turn_count", 0)
          summary = data.get("summary", "")
          messages = data.get("messages", [])

          # è®¡ç®— token ä¼°ç®—
          total_chars = sum(len(m.get("content", "")) for m in messages)
          total_tokens = total_chars // 4

          # ç”Ÿæˆæ‘˜è¦è¯„è®º
          output = []
          output.append(f"ğŸ¯ **å¯¹è¯ä¸»é¢˜**: {topic}")
          output.append("")
          output.append(f"ğŸ“Š **ç»Ÿè®¡**: {turn_count} è½®å¯¹è¯, ~{total_tokens:,} tokens")
          output.append("")

          if summary:
              output.append("ğŸ“ **å¯¹è¯æ€»ç»“**")
              output.append(summary)
              output.append("")

          output.append("ğŸ’¾ **å®Œæ•´å¯¹è¯æ—¥å¿—**: å·²ä¿å­˜ä¸º GitHub Artifact")
          output.append(f"ğŸ“ æ–‡ä»¶: `{json_files[0].name}`")

          Path("/tmp/summary.txt").write_text("\n".join(output), encoding="utf-8")
          PYTHON_SCRIPT

      - name: Upload conversation as artifact
        id: upload_artifact
        if: steps.check_chat.outputs.is_chat == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: conversation-${{ steps.get_issue.outputs.number }}-${{ github.run_number }}
          path: history/*.json
          retention-days: 90

      - name: Post summary comment
        if: steps.check_chat.outputs.is_chat == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT_URL: ${{ steps.upload_artifact.outputs.artifact-url }}
        run: |
          # åœ¨æ‘˜è¦æœ«å°¾æ·»åŠ  artifact ä¸‹è½½é“¾æ¥
          echo "" >> /tmp/summary.txt
          echo "ğŸ”— [ä¸‹è½½å®Œæ•´å¯¹è¯]($ARTIFACT_URL)" >> /tmp/summary.txt
          gh issue comment "${{ steps.get_issue.outputs.number }}" --body-file /tmp/summary.txt
