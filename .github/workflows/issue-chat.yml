name: Issue Chat

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  issues: write

jobs:
  chat:
    if: |
      contains(github.event.issue.labels.*.name, 'chat') ||
      contains(github.event.issue.labels.*.name, 'ÂØπËØù') ||
      startsWith(github.event.issue.title, '[ÂØπËØù]')
    name: Run Conversation via Issue
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"
          python-version: "3.13"

      - name: Install dependencies
        run: |
          uv venv .venv
          uv sync --extra dev

      - name: Run conversation and post comment
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          uv run python << 'EOF'
          import asyncio
          import os
          import re
          from mind.agent import Agent
          from mind.conversation import ConversationManager
          from mind.memory import MemoryManager, TokenConfig
          from mind.prompts import get_default_config_path, load_agent_configs

          async def run_conversation():
              # Ë∞ÉËØïÔºöÊ£ÄÊü•ÁéØÂ¢ÉÂèòÈáè
              api_key = os.getenv("ANTHROPIC_API_KEY")
              print(f"üîë API Key ÈïøÂ∫¶: {len(api_key) if api_key else 0}")
              print(f"üîë API Key ÂâçÁºÄ: {api_key[:7]}...{api_key[-4:] if api_key else 'None'}")

              # ÈÖçÁΩÆ
              MAX_TURNS = 500
              issue_title = os.getenv("ISSUE_TITLE")
              issue_body = os.getenv("ISSUE_BODY")
              issue_number = os.getenv("ISSUE_NUMBER")

              # ÊûÑÂª∫‰∏ªÈ¢ò
              topic = issue_title
              if issue_body:
                  topic = f"{topic}\n\n{issue_body}"

              print(f"üìù Issue #{issue_number}: {issue_title}")

              # Âä†ËΩΩÊô∫ËÉΩ‰ΩìÈÖçÁΩÆ
              config_path = str(get_default_config_path())
              agent_configs = load_agent_configs(config_path)

              # ÂàõÂª∫Êô∫ËÉΩ‰Ωì
              supporter = Agent(
                  name=agent_configs["supporter"].name,
                  system_prompt=agent_configs["supporter"].system_prompt,
              )
              challenger = Agent(
                  name=agent_configs["challenger"].name,
                  system_prompt=agent_configs["challenger"].system_prompt,
              )

              # ÂàõÂª∫ÂØπËØùÁÆ°ÁêÜÂô®Ôºà‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆÔºö150k tokensÔºå3Ê¨°Ê∏ÖÁêÜÂêéÈÄÄÂá∫Ôºâ
              manager = ConversationManager(
                  agent_a=supporter,
                  agent_b=challenger,
                  memory=MemoryManager(TokenConfig()),
                  turn_interval=0.1,
              )

              # Êî∂ÈõÜËæìÂá∫
              output = []
              output.append(f"üéØ **ÂØπËØù‰∏ªÈ¢ò**: {topic}")
              output.append("")
              output.append("---")
              output.append("")

              # ÂàùÂßãÂåñ‰∏ªÈ¢ò
              topic_msg = {
                  "role": "user",
                  "content": f"ÂØπËØù‰∏ªÈ¢òÔºö{topic}\n\nËØ∑Ê†πÊçÆ‰Ω†‰ª¨ÁöÑËßíËâ≤Â±ïÂºÄÊé¢ËÆ®„ÄÇ",
              }
              manager.messages.append(topic_msg)
              manager.memory.add_message(topic_msg["role"], topic_msg["content"])

              # ËøêË°åÂØπËØù
              turn_count = 0
              for _ in range(MAX_TURNS):
                  current_agent = manager.agent_a if manager.current == 0 else manager.agent_b

                  output.append(f"### [{current_agent.name}]")
                  response = await current_agent.respond(manager.messages, manager.interrupt)

                  if response is not None:
                      # ÁßªÈô§ÂèØËÉΩÁöÑÂâçÁºÄ
                      patterns = [
                          rf"^\[{re.escape(current_agent.name)}\]:\s*",
                          rf"^\[{re.escape(current_agent.name)}]\uFF1A\s*",
                          rf"^\*\*{re.escape(current_agent.name)}\uFF1A\*\*\s*",
                          rf"^\*\*{re.escape(current_agent.name)}:\*\*\s*",
                          rf"^{re.escape(current_agent.name)}\uFF1A\s*",
                      ]
                      for pattern in patterns:
                          response = re.sub(pattern, "", response, count=1).lstrip()

                      output.append(response)
                      output.append("")

                      formatted = f"[{current_agent.name}]: {response}"
                      msg = {"role": "assistant", "content": formatted}
                      manager.messages.append(msg)
                      manager.memory.add_message(msg["role"], msg["content"])
                      manager.turn += 1
                      turn_count += 1
                      manager.current = 1 - manager.current

                      # Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊ∏ÖÁêÜ
                      status = manager.memory.get_status()
                      if status == "red":
                          manager._trim_count += 1
                          old_count = len(manager.messages)
                          manager.messages = manager.memory.trim_messages(manager.messages)
                          new_count = len(manager.messages)

                          # Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÈÄÄÂá∫
                          if manager.should_exit_after_trim():
                              manager.summary = await manager._summarize_conversation()
                              output.append("")
                              output.append("---")
                              output.append("")
                              output.append("‚ö†Ô∏è ÂØπËØùÁªìÊùüÔºà‰∏ä‰∏ãÊñáË∂ÖÈôêÔºâ")
                              output.append("")
                              output.append("üìù **ÂØπËØùÊÄªÁªì**")
                              output.append(manager.summary)
                              break

              # Ê∑ªÂä†ÁªüËÆ°
              output.append("")
              output.append("---")
              output.append("")
              output.append(f"üìä **ÁªüËÆ°**: {turn_count} ËΩÆÂØπËØù, {manager.memory._total_tokens} tokens")

              # ËæìÂá∫ÁªìÊûú
              result = "\\n".join(output)
              print(result)

              # ‰øùÂ≠òÂà∞Êñá‰ª∂‰æõ gh ÂëΩ‰ª§‰ΩøÁî®
              with open("/tmp/comment.txt", "w", encoding="utf-8") as f:
                  f.write(result)

          # ËøêË°åÂºÇÊ≠•ÂáΩÊï∞
          asyncio.run(run_conversation())
          EOF

          # ‰ΩøÁî® gh ÂèëÂ∏ÉËØÑËÆ∫
          gh issue comment "$ISSUE_NUMBER" --body-file /tmp/comment.txt
