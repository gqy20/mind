name: Issue Chat

on:
  issues:
    types: [opened]
  # 也可以通过手动触发
  workflow_dispatch:
    inputs:
      issue_number:
        description: Issue 编号
        required: true
        type: number

permissions:
  contents: write
  issues: write

jobs:
  chat:
    if: |
      contains(github.event.issue.labels.*.name, 'chat') ||
      contains(github.event.issue.labels.*.name, '对话') ||
      startsWith(github.event.issue.title, '[对话]')
    name: Run Conversation via Issue
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"
          python-version: "3.13"

      - name: Install dependencies
        run: |
          uv venv .venv
          uv sync --extra dev

      - name: Run conversation and post comment
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # 构建主题（如果 body 存在则换行拼接）
          if [ -n "$ISSUE_BODY" ]; then
            TOPIC="$ISSUE_TITLE"$'\n\n'"$ISSUE_BODY"
          else
            TOPIC="$ISSUE_TITLE"
          fi

          # 运行对话并输出到文件
          uv run python -m mind.cli "$TOPIC" --non-interactive --max-turns 10 > /tmp/comment.txt

          # 使用 gh 发布评论
          gh issue comment "$ISSUE_NUMBER" --body-file /tmp/comment.txt
