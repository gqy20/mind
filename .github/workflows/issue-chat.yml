name: Issue Chat

on:
  issues:
    types: [opened]
  # 也可以通过手动触发
  workflow_dispatch:
    inputs:
      issue_number:
        description: Issue 编号
        required: true
        type: number

permissions:
  contents: write
  issues: write

jobs:
  chat:
    name: Run Conversation via Issue
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          python-version: "3.13"

      - name: Install dependencies
        run: |
          uv venv .venv
          uv sync --group dev

      - name: Get issue details
        id: get_issue
        run: |
          # 确定使用哪个 issue 编号
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER=${{ github.event.inputs.issue_number }}
          else
            ISSUE_NUMBER=${{ github.event.issue.number }}
          fi
          echo "number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          # 获取 issue 详情
          TITLE=$(gh issue view "$ISSUE_NUMBER" --json title --jq '.title')
          BODY=$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body')
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "body=$BODY" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run conversation and post comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ISSUE_TITLE: ${{ steps.get_issue.outputs.title }}
          ISSUE_BODY: ${{ steps.get_issue.outputs.body }}
          ISSUE_NUMBER: ${{ steps.get_issue.outputs.number }}
        run: |
          # 检查是否为对话 issue
          if ! echo "$ISSUE_TITLE" | grep -q '^\[对话\]'; then
            if ! gh issue view "$ISSUE_NUMBER" --json labels --jq '.labels[].name' | grep -qE '(chat|对话)'; then
              echo "This is not a chat issue, skipping..."
              exit 0
            fi
          fi

          # 构建主题（如果 body 存在则换行拼接）
          if [ -n "$ISSUE_BODY" ]; then
            TOPIC="$ISSUE_TITLE"$'\n\n'"$ISSUE_BODY"
          else
            TOPIC="$ISSUE_TITLE"
          fi

          # 运行对话并输出到文件
          uv run python -m mind.cli "$TOPIC" --non-interactive --max-turns 50 > /tmp/comment.txt

          # 使用 gh 发布评论
          gh issue comment "$ISSUE_NUMBER" --body-file /tmp/comment.txt
